/*
 * AutoSuggest
 * Copyright 2009-2010 Drew Wilson
 * www.drewwilson.com
 * code.drewwilson.com/entry/autosuggest-jquery-plugin
 *
 * Version 1.4   -   Updated: Mar. 23, 2010
 *
 * This Plug-In will auto-complete or auto-suggest completed search queries
 * for you as you type. You can add multiple selections and remove them on
 * the fly. It supports keybord navigation (UP + DOWN + RETURN), as well
 * as multiple AutoSuggest fields on the same page.
 *
 * Inspired by the Autocomplete plugin by: Jï¿½rn Zaefferer
 * and the Facelist plugin by: Ian Tearle (iantearle.com)
 *
 * This AutoSuggest jQuery plug-in is dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 */
(function(a){a.fn.autoSuggest=function(b,c){var d={asHtmlID:!1,asHtmlName:!1,newValuesInputName:!1,startText:"Enter Name Here",emptyText:"No Results Found",preFill:{},limitText:"No More Selections Are Allowed",selectedItemProp:"value",selectedValuesProp:"value",searchObjProps:"value",queryParam:"q",retrieveLimit:!1,extraParams:"",matchCase:!1,minChars:1,keyDelay:400,resultsHighlight:!0,neverSubmit:!1,selectionLimit:!1,showResultList:!0,start:function(){},selectionClick:function(a){},selectionAdded:function(a){a.textLimit(12)},selectionRemoved:function(a){a.remove()},formatList:!1,beforeRetrieve:function(a){return a},retrieveComplete:function(a){return a},resultClick:function(a){},resultsComplete:function(){}},e=a.extend(d,c),f="object",g=0;if(typeof b=="string"){f="string";var h=b}else{var i=b;for(k in b)b.hasOwnProperty(k)&&g++}if(f=="object"&&g>0||f=="string")return this.each(function(b){function D(){if(lastKeyPressCode==46||lastKeyPressCode>8&&lastKeyPressCode<32)return p.hide();if(e.selectionLimit&&a("li.as-selection-item",n).length>=e.selectionLimit)return;var b=j.val().replace(/[\\]+|[\/]+/g,"");if(b==A)return;A=b;if(b.length>=e.minChars){n.addClass("loading");if(f=="string"){var c="";e.retrieveLimit&&(c="&limit="+encodeURIComponent(e.retrieveLimit)),e.beforeRetrieve&&(b=e.beforeRetrieve.call(this,b)),a.getJSON(h+"?"+e.queryParam+"="+encodeURIComponent(b)+c+e.extraParams,function(a){g=0;var c=e.retrieveComplete.call(this,a);for(k in c)c.hasOwnProperty(k)&&g++;F(c,b)})}else e.beforeRetrieve&&(b=e.beforeRetrieve.call(this,b)),F(i,b)}else n.removeClass("loading"),p.hide()}function F(b,c){var d=c;e.matchCase||(c=c.toLowerCase());var f=0;p.html(q.html("")).hide();for(var h=0;h<g;h++){var i=h;E++;var k=!1;if(e.searchObjProps=="value")var o=b[i].value;else{var o="",s=e.searchObjProps.split(",");for(var t=0;t<s.length;t++){var u=a.trim(s[t]);o=o+b[i][u]+" "}}o&&(e.matchCase||(o=o.toLowerCase()),o.search(c)!=-1&&r.val().search(","+b[i][e.selectedValuesProp]+",")==-1&&(k=!0));var v=a('<li class="as-result-item" id="as-result-item-'+i+'"></li>').click(function(){var b=a(this).data("data"),c=b.num;if(a("#as-selection-"+c,n).length<=0&&!C){var d=b.attributes;j.val("").focus(),A="",G(d,c),e.resultClick.call(this,b),p.hide()}C=!1}).mousedown(function(){l=!1}).mouseover(function(){a("li",q).removeClass("active"),a(this).addClass("active")}).data("data",{attributes:b[i],num:E}),w=a.extend({},b[i]);if(!e.matchCase)var x=new RegExp("(?![^&;]+;)(?!<[^<>]*)("+c+")(?![^<>]*>)(?![^&;]+;)","gi");else var x=new RegExp("(?![^&;]+;)(?!<[^<>]*)("+c+")(?![^<>]*>)(?![^&;]+;)","g");e.resultsHighlight&&(w[e.selectedItemProp]=w[e.selectedItemProp].replace(x,"<em>$1</em>")),e.formatList?v=e.formatList.call(this,w,v):v=v.html(w[e.selectedItemProp]),q.append(v),delete w,f++;if(e.retrieveLimit&&e.retrieveLimit==f)break}n.removeClass("loading");if(f<=0){var v=a('<li class="as-result-item" id="as-result-item-1"></li>');e.newValuesInputName?(m+=1,v.html("Add new: <em>"+d+"</em>").click(function(){l=!1,new_data_item={},new_data_item[e.selectedItemProp]=d,new_data_item[e.selectedValuesProp]=d,G(new_data_item,m,!0),j.val(""),p.hide()}).mousedown(function(){l=!1}).mouseover(function(){a("li",q).removeClass("active"),a(this).addClass("active")})):v.html("<em>New items not allowed in this field</em>"),q.append('<li class="as-message">'+e.emptyText+"</li>").append(v)}q.css("width",n.outerWidth()),p.show(),e.resultsComplete.call(this)}function G(b,c,d){d=d||!1,d?r.after('<input type="hidden" name="'+e.newValuesInputName+'" value="'+b[e.selectedValuesProp]+'">'):r.val(r.val()+b[e.selectedValuesProp]+",");var f=a('<li class="as-selection-item" id="as-selection-'+c+'"></li>').click(function(){e.selectionClick.call(this,a(this)),n.children().removeClass("selected"),a(this).addClass("selected")}).mousedown(function(){l=!1}),g=a('<a class="as-close">&times;</a>').click(function(){return d?a("input[value="+b[e.selectedValuesProp]+"]").remove():r.val(r.val().replace(","+b[e.selectedValuesProp]+",",",")),e.selectionRemoved.call(this,f),l=!0,j.focus(),!1});o.before(f.html(b[e.selectedItemProp]).prepend(g)),e.selectionAdded.call(this,o.prev())}function H(b){if(a(":visible",p).length>0){var c=a("li",p);if(b=="down")var d=c.eq(0);else var d=c.filter(":last");var e=a("li.active:first",p);e.length>0&&(b=="down"?d=e.next():d=e.prev()),c.removeClass("active"),d.addClass("active")}}if(!e.asHtmlID){b=b+""+Math.floor(Math.random()*100);var c="as-input-"+b,d="as_values_"+b}else{b=e.asHtmlID;var c=b,d="as_values_"+b}if(e.asHtmlName)var d=e.asHtmlName;e.start.call(this);var j=a(this);j.attr("autocomplete","off").addClass("as-input").attr("id",c).val(e.startText);var l=!1;j.wrap('<ul class="as-selections" id="as-selections-'+b+'"></ul>').wrap('<li class="as-original" id="as-original-'+b+'"></li>');var m=0,n=a("#as-selections-"+b),o=a("#as-original-"+b),p=a('<div class="as-results" id="as-results-'+b+'"></div>').hide(),q=a('<ul class="as-list"></ul>'),r=a('<input type="hidden" class="as-values" name="'+d+'" id="as-values-'+b+'" />'),s="";if(typeof e.preFill=="string"){var t=e.preFill.split(",");for(var u=0;u<t.length;u++){var v={};v[e.selectedValuesProp]=t[u],t[u]!=""&&G(v,"000"+u)}s=e.preFill}else{s="";var w=0;for(k in e.preFill)e.preFill.hasOwnProperty(k)&&w++;if(w>0)for(var u=0;u<w;u++){var x=e.preFill[u][e.selectedValuesProp];x==undefined&&(x=""),s=s+x+",",x!=""&&G(e.preFill[u],"000"+u)}}if(s!=""){j.val("");var y=s.substring(s.length-1);y!=","&&(s+=","),r.val(","+s),a("li.as-selection-item",n).addClass("blur").removeClass("selected")}j.after(r),n.click(function(){l=!0,j.focus()}).mousedown(function(){l=!1}).after(p);var z=null,A="",B=0,C=!1;j.focus(function(){return a(this).val()==e.startText&&r.val()==""?a(this).val("").removeClass("as-prompt"):l&&(a("li.as-selection-item",n).removeClass("blur"),a(this).val()!=""&&(q.css("width",n.outerWidth()),p.show())),l=!0,!0}).click(function(){n.children().removeClass("selected")}).blur(function(){a(this).val()==""&&r.val()==""&&s==""?a(this).val(e.startText).addClass("as-prompt"):l&&(a("li.as-selection-item",n).addClass("blur").removeClass("selected"),p.hide())}).keydown(function(b){lastKeyPressCode=b.keyCode,first_focus=!1;switch(b.keyCode){case 38:b.preventDefault(),H("up");break;case 40:b.preventDefault(),H("down");break;case 8:if(j.val()==""){var c=r.val().split(",");c=c[c.length-2],n.children().not(o.prev()).removeClass("selected"),o.prev().hasClass("selected")?(r.val(r.val().replace(","+c+",",",")),e.selectionRemoved.call(this,o.prev())):(e.selectionClick.call(this,o.prev()),o.prev().addClass("selected"))}j.val().length==1&&(p.hide(),A=""),a(":visible",p).length>0&&(z&&clearTimeout(z),z=setTimeout(function(){D()},e.keyDelay));break;case 13:C=!1;var d=a("li.active:first",p);if(d.length>0)d.click(),p.hide();else{var f=j.val().replace(/(,)/g,"");if(f!=""&&r.val().search(","+f+",")<0&&f.length>=e.minChars){C=!0,b.preventDefault();var g={};g[e.selectedItemProp]=f,g[e.selectedValuesProp]=f;var h=a("li",n).length;G(g,"00"+(h+1)),j.val("")}}(e.neverSubmit||d.length>0)&&b.preventDefault();break;case 32:case 9:case 188:if(e.spaceSeparatesItems||b.keyCode!==32){C=!0;var f=j.val().replace(/(,)/g,"");e.spaceSeparatesItems&&(f=f.replace(/ /g,""));if(f!=""&&r.val().search(","+f+",")<0&&f.length>=e.minChars){b.preventDefault();var g={};g[e.selectedItemProp]=f,g[e.selectedValuesProp]=f;var h=a("li",n).length;G(g,"00"+(h+1)),j.val("")}};default:e.showResultList&&(e.selectionLimit&&a("li.as-selection-item",n).length>=e.selectionLimit?(q.html('<li class="as-message">'+e.limitText+"</li>"),p.show()):(z&&clearTimeout(z),z=setTimeout(function(){D()},e.keyDelay)))}});var E=0})}})(jQuery)